/**
 * 在线简历简历数据操作
 * @author huangcanhui
 * 文档提示
 * .moduleItem 标记模块
 * .moduleItemList 标记模块下的子栏目
 * .divIconFont 标记自定义图标
 **/
var cvresume = cvresume || {};
cvresume.main = cvresume.main || {};
cvresume.info={
		itemid:0,
		resumeid:0,
		memberid:0,
		downloadFlag:false,
		downloadUrl:"",
		resumecontentid:0,
		visitid:"",
		sortPosition:["Left","Top","Right","Bottom"],
		cases:"",
		language:"zh",
		resume_type:"文档",
		resume_fontType_change:-1, //0：简历，1：繁体，-1：不做任何操作
		timeout_resume_save: {},		// 简历保存延迟定时器
}
cvresume.localStorage=true;//localStorge兼容，方便测试（默认true）
cvresume.save_trigger=true;
cvresume.resume_save_trigger=true;
cvresume.module_save_trigger=true;//模块数据保存
cvresume.history_save_trigger=true;//历史记录
cvresume.cur_opt_content="";//当前用户正在操作原始数据，使用获得焦点数据保存
cvresume.main = {
		event_: function () {//事件绑定
			cvresume.main.moduleItemList_handlestyle();
	    	//分享功能
	    	$("#shareResume-modal #copyUrl").on("click",function(){
	        	 var str = $(".shareContent span").html() + $(".shareContent input").val()+"/";
	        	 cvresume.main.set_copyToClipBoard(str);
	             $("#copyUrl").html("复制成功");
	             setTimeout(function(){
	                 $("#copyUrl").html("复制链接")
	             },2000);
	        });
	    	
	    	//设置隐私id
	    	$("#visitid").change(function(){
	    		cvresume.main.set_visitid($(this).val());
	    	});
	    	//设置访问类别
	    	$("#resume_authority_modal .authority_list:not(li:eq(1))").click(function(){
	    		if(cvresume.main.is_empty(cvresume.info.resumeid)){
	    			layer.msg("没有登录");
	    		}else{
		    		var data_type=$(this).attr("data-type");
		    		if(!cvresume.main.is_empty(data_type)){
		    			$.post("/cvresume/set_visit_type/",{"visitType":data_type,"resumeid":cvresume.info.resumeid},function(message){
		    				if(message.type=="success"){
		    					$("#edit_resume_sharebtn").attr("data-visittype",data_type)
		    				}
		    			});
		    		}
	    		}
	    	});
	    	//设置访问密码
	    	$("#visitPasswordSubBtn").click(function(){
	    		//设置密码访问类别
	    		var data_type=$("#resume_authority_modal .authority_list:nth-child(1)").attr("data_type");
		    	if(!cvresume.main.is_empty(data_type)){
		    		$.post("/cvresume/set_visit_type/",{"visitType":data_type,"resumeid":cvresume.info.resumeid},function(message){
		    			$("#edit_resume_sharebtn").attr("data-visittype",data_type)
		    		});
		    	}
		    	var password=$("#visitPassword").val();
		    	if(cvresume.main.is_empty(password)){
					layer.msg("密码不能为空~");
					return;
		    	}
	    		if(password.length > 6){
	                layer.msg("密码长度不允许超过6位数！");
	                return;
	            }
	            if(!/^[0-9]*$/.test(password)){
	                layer.msg("密码只允许输入数字！");
	                return;
				}
				$.post("/cvresume/set_visit_password/",{"password":password,"resumeid":cvresume.info.resumeid},function(message){
    				if(message.type=="success"){
						layer.msg("密码设置成功~");
                        $("#resume_authority_modal").modal("hide");
                    }else{
    					layer.msg(message.content);
    				}
    			});
	    	});
            
			// 简历 设置/修改 名称/标题 ------------------------
			/**
			 * __resume_name__  			原本的简历名称
			 * __resumename_illegal   		简历非法字符匹配
			 * __resumename_illegal_close   清除非法字符规则
			 * info_object     				生成简历名称的字段
			 * reload_info_object()    		更新字段内容
			 * show_selected_resumetitle()	渲染生成标题字段的选中效果
			 */
			var __resume_name__ = $('#resumeName_value').val();
			var __resumename_illegal = /^[a-zA-Z0-9_@\.\- \u4e00-\u9fa5]*$/;
			var __resumename_illegal_close = /[^a-zA-Z0-9_@\.\- \u4e00-\u9fa5]*/g;
            // 7个字段对应的dom
            var info_object = {};
            // 刷新value
            reload_info_object();
            function reload_info_object(){
                info_object = {
                    'jobFunction': $('#jobFunction span').text(),
                    'name': $('#resume_name .name').text(),
                    'jobYear': $('#jobYear span').text(),
                    'mobile': $('#mobile span').text(),
                    'email': $('#email span').text(),
                    'education': $('#education span').text(),
                    'cityName': $('#city span').text(),
                }
            }
			// 回显选中的li   先设置好顶部标题的选中
			if ($('#head_resume_name').length > 0) show_selected_resumetitle($('#head_resume_name'));
            function show_selected_resumetitle($input){
                var base_info = $input.val().split(/\s?-\s?/);	// 正则匹配 - 分割 前后有无空格都分割
				$input.attr('readonly', 'readonly');
				$('.set_resumename_panel .panel_operate li').removeClass('selected');
                base_info.forEach(function(info_item){
                    for (var i in info_object) {
                        if (info_item === info_object[i]) {
                            $('.set_resumename_panel .panel_operate li[data-data="'+ i +'"]').addClass('selected');
                            break;
                        }
                    }
				});
				// 有内容 && 没匹配信息项
                if ($input.val() !== '' && $input.parent().find('.set_resumename_panel .panel_operate li:not(.custom).selected').length !== base_info.length) {
                    $('.set_resumename_panel .panel_operate li.custom').addClass('selected').siblings('li').removeClass('selected');
                }
            }
			/**
			 * 简历命名(顶部命名框)
			 */
            // 设置名称面板 显示/隐藏
            $('#head_resume_name').on('click', function(){
                if (!$(this).attr('readonly')) return;
                $(this).addClass('focus');
				$(this).siblings('.set_resumename_panel').fadeIn();
				$(document).off('click', click_ohter_closepanel).on('click', click_ohter_closepanel);
				reload_info_object();
				// 自定义输入移除文本框只读属性
				show_selected_resumetitle($(this));
				if ($(this).siblings('.set_resumename_panel').find('.panel_operate li.custom').hasClass('selected')) {
					$(this).removeAttr('readonly');
				}
            });
            // 面板设置简历名称 （头部 和 命名弹窗统一）
            $('.set_resumename_panel .panel_operate li').on('click', function(){
                var $input = $('#head_resume_name, #resumeName_value');
                // 自定义名称
                if ($(this).attr('data-data') === 'custom') {
                    if (!$(this).hasClass('selected')) {
                        $(this).addClass('selected').siblings('li').removeClass('selected');
                        $input.removeAttr('readonly').val('');
                        $(this).parents('.set_resumename_panel').siblings('input.resume_name').focus();
                    } else {
                        $(this).parents('.set_resumename_panel').siblings('input.resume_name').focus();
                    }
                } else {
                    $(this).toggleClass('selected');
                    // 使用基本信息组成名称
                    $(this).siblings('li[data-data="custom"]').removeClass('selected');
                    $input.attr('readonly', 'readonly');
                    var resume_title_baseinfo = [];
					reload_info_object();
					// 当前选择项没有内容不添加到数组
					var $selected_arr = $(this).parent().children('li.selected').toArray();
					for (var i in $selected_arr) {
						var $selected_li = $($selected_arr[i]);
						var value = info_object[$selected_li.attr('data-data')];
						if (value.replace(/\s+/g, '') === '') {
							layer.msg($selected_li.text() + '未填写！');
							$selected_li.removeClass('selected');
							continue;
						}
						// 清除特殊字符
						if (!__resumename_illegal.test(value)) {
							value = value.replace(__resumename_illegal_close, '');
						}
						resume_title_baseinfo.push(value);
					}
					$input.val(resume_title_baseinfo.join(' - '));
                }
			});
			// 触发关闭
            $('.header_resume_area .set_resumename_panel .panel_close').on('click', close_resumetitle_panel);
            $('#head_resume_name, #resumeName_value').on('input', function(){
                // 同步到命名内容
                $('#head_resume_name, #resumeName_value').val($(this).val());
            });
            // 关闭设置标题面板  自定义输入保存
            function close_resumetitle_panel(){
                var $input = $('#head_resume_name');
                // 空命名使用默认
                if ($input.val().replace(/\s+/g, '') === '') {
					$('#head_resume_name, #resumeName_value').val('我的简历 - ' + common.main.date_format(new Date(), 'yyyyMMddmmss'));
				}
                if (__resume_name__ !== $input.val()) {
					__resume_name__ = $input.val();
					// 头部标题命名保存  清除特殊字符
					if (!__resumename_illegal.test($input.val())) {
						$input.val($input.val().replace(__resumename_illegal_close, ''));
						layer.msg('不能输入特殊字符');
					}
					cvresume.main.base_resume_save(true,cvresume.main.get_resume(),false);
				}
                $input.removeClass('focus').attr('readonly', 'readonly');
				$('.header_resume_area .set_resumename_panel').fadeOut();
				$(document).off('click', click_ohter_closepanel);
			}
			// 点击其他地方关闭
			function click_ohter_closepanel(e){
				if (!e) return;
				var $click_this = $(e.target);
				if ($click_this.parents('.header_resume_area').length === 0) {
					close_resumetitle_panel();
				}
			}
            /**
			 * 简历命名(弹框) 保存
			 */
            $("#resumeName .submit").click(function(){
            	var $input = $('#resumeName_value');
                if ($input.val().replace(/\s+/g, '') === '') {
                    return layer.msg('请输入简历名称');
				}
                __resume_name__ = $input.val();
				// 清除特殊字符
                if (!__resumename_illegal.test($input.val())) {
					$input.val($input.val().replace(__resumename_illegal_close, ''));
                    layer.msg('不能输入特殊字符');
                }
                $input.removeClass('focus').attr('readonly', 'readonly');
                $('#resumeName').modal('hide');
                cvresume.main.base_resume_save(true,cvresume.main.get_resume(),false);
			});
			/**
			 * 监听内容生成标题的字段改变，同步标题名称
			 */
			function listenter_title(){
				// 以字段生成的标题编辑简历后同步标题名称
				if (!$('.header_resume_area .panel_operate li.custom').hasClass('selected')) {
					reload_info_object();
					var $selected_arr = $('.header_resume_area .panel_operate li.selected').toArray();
					var resume_title_baseinfo = [];
					var $input = $('#head_resume_name, #resumeName_value');
					// 当前选择项没有内容不添加到数组
					for (var i in $selected_arr) {
						var $selected_li = $($selected_arr[i]);
						var value = info_object[$selected_li.attr('data-data')];
						// 清除特殊字符
						if (!__resumename_illegal.test(value)) {
							value = value.replace(__resumename_illegal_close, '');
						}
						resume_title_baseinfo.push(value);
					}
					$input.val(resume_title_baseinfo.join(' - '));
				}
			}
			$(document).on('click', '#baseMsg-modal .submit, #jobIntension-modal .submit', listenter_title);
			$(document).on('blur', '#resume_name .name', listenter_title);
			/**
			 * 生成初始标题
			 * 从创建流程新建的简历设置标题  定义fn 防止变量污染
			 */
			newresume_settitle();
			function newresume_settitle(){
				// 新创建的简历
				if (!cvresume.info.resumeid) {
					var $input = $('#head_resume_name, #resumeName_value');
					var resume_title_baseinfo = [];
					var info_object_index = 0;
					// 遍历基本信息字段 获取前4个 岗位 - 姓名 - 年限 - 电话
					for (var l in info_object) {
						if (!common.main.is_empty(info_object[l]) && info_object_index < 4) {
							resume_title_baseinfo.push(info_object[l]);
						}
						info_object_index++;
					}
					// 有填写set标题 && 处理特殊字符
					if (resume_title_baseinfo.length > 0) {
						var resume_title_baseinfo_str = resume_title_baseinfo.join(' - ');
						if (!__resumename_illegal.test(resume_title_baseinfo_str)) {
							resume_title_baseinfo_str = resume_title_baseinfo_str.replace(__resumename_illegal_close, '');
						}
						$input.val(resume_title_baseinfo_str);
					}
				}
			}
            // 设置简历名称/标题 end-----------
            
    		//历史记录列表
			$(".czls a").click(function(){
				cvresume.main.get_resume_history();
			});
			//发布(保存->简历->历史记录)
			$(document).on("click","#cvresumeDownloadBtn",function(){
				if (cvmutual.info.resume_type == '手机' || $(this).hasClass('wbd-vip-lock')) return;
	    		var resume_title = $("#resumeName_value").val();
	    		var url_resume_title = decodeURI(common.main.getUrlParamsValue("title"));
	 	    	if($("html").hasClass("ie9")){
	 	    		alert("当前浏览器内核为ie9,如果简历加载不出来,请更换浏览器,或切换至极速模式,可以正常下载简历.");
	 	    	}
	    		if(cvresume.main.is_empty(resume_title) && (cvresume.main.is_empty(url_resume_title) || url_resume_title == "null")){//如果简历未保存并且url没带简历命名就弹出简历命名框
	    			$("#resumeName").modal("show");
                    show_selected_resumetitle($("#resumeName_value"));
	    		}else{
	    			var isSaveSuccess = cvresume.main.resume_save(true,false);
					if(isSaveSuccess){
						var _href = "/cvresume/release/"+cvresume.info.visitid+"/"
						if(!cvresume.main.is_empty($(this).attr("data-value"))){
							_href += "?device="+$(this).attr("data-value");
						}
						window.open(_href);
					}
	    		}
	    		return;
			});
			//简历打印
			$(document).on("click","#cvresumePrintBtn:not(.wbd-vip-lock)",function(){
				cvresume.main._500dtongji("PC-CV6.9.5-简历编辑页-编辑器-顶部-右上角-打印");
				var css_path = $(this).attr("data-css");
    			$.ajax({
		    		type: "POST",
					url: "/member/check_vip_rank/",
					cache: false,
		           	success:function(message){
		           		if(message.content == "novip"){
		           			layer.msg("您还没有这个权限,请升级后再进行操作");
		           			common.main.vip_opt_tips();
			    			return;
			    		}else{
							if (cvmutual.info.resume_type == '手机' || $(this).hasClass('wbd-vip-lock')) return;
							//如果是IE,提示用户更换浏览器打印或使用下载简历功能
				 	    	if (window.ActiveXObject || "ActiveXObject" in window){
				 	    		alert("暂不支持IE浏览器打印功能,请更换浏览器或使用简历下载功能")
				 	    		return;
							}
							var print_html = '<div class="printtips_img"></div>'+
											 '<p>1、在打印设置中将边距设置为 <span>“无”</span></p>'+
											 '<p>2、然后请勾选 <span>“背景图形”</span></p>';
							common.main.resume_confirm({
								title: "打印提示",
								content_html: print_html,
								modal_class:"resume_printtips_modal",
								ok: '知道了，去打印',
								onOk: function(){
									var version = new Date().getTime();
									// 打印时隐藏其他内容
									$("#resume_base .baseItem-toolbar").addClass("hidden");
						 	    	$("#resume_base .date_select").addClass("hidden");
									$("#resume_base .page_tips").addClass("hidden");
						 	    	$("#resume_base").print({
					 	    		    globalStyles:false,//是否包含父文档的样式，默认为true
					 	    		    stylesheet:[
					 	    				"/resources/500d/cvresume/css/base_template.css?v=" + version,
					 	    				"/resources/500d/cvresume/css/parts_css.css?v=" + version,
					 	    				"/resources/500d/cvresume/css/export.css?v=" + version,
					 	    				css_path + '?v=' + version,
					 	    			]//外部样式表的URL地址，默认为null
									});
									$("#resume_base .baseItem-toolbar").removeClass("hidden");
						 	    	$("#resume_base .date_select").removeClass("hidden");
									$("#resume_base .page_tips").removeClass("hidden");
								}
							});
			    		}
	           	 	}
		    	});
			});
			//自动调整为1页功能
			$(document).on("click","#autoOnePage", function(){
				cvresume.main._500dtongji("PC-CV6.9.5-简历编辑页-编辑器-画布底部-底部-自动一页");
				var $this = $(this),
					_resumePageHeight = 1160,// 每页高度
					_line_height_arr = ["3","2.5","2","1.5","1"], //行高
					_page_distance_arr = ["1.5","1","0.8","0.5"],//页边距
					_module_distance_arr = ["1.6","1.4","1.2","1","0.8","0.6","0.4","0.2","0"],//模块距离
					_can_save = true;
				// 延迟800毫秒 显示动画效果
				$this.find('.roundToggleBtn').removeClass('off');
				$('.autopage_masking').fadeIn(100);
				setTimeout(function(){
					//文本输入框，删除内容为空的div
					$(".wbdCv-resume .resume_content").find("div,p,li").each(function(){
						if(common.main.is_empty($(this).text())){
							$(this).remove();
						}
					});
					//调整行高
					$.each(_line_height_arr,function(index,value){
						$(".wbdCv-resume [style*=line-height]").each(function(){
							$(this).css("line-height", value);
							var _current_line_height = $(".wbdCv-resume").css({"height" : "auto"}).outerHeight();
							if(_current_line_height <= _resumePageHeight){
								return _can_save = false;
							}
						});
					});
					//调整模块距离
					if(_can_save){
						$.each(_module_distance_arr,function(index,value){
							$("#resume_base").attr("data-modal_margin",value);
							var _current_line_height = $(".wbdCv-resume").css({"height" : "auto"}).outerHeight();
							if(_current_line_height <= _resumePageHeight){
								return _can_save = false;
							}
						});
					}
					//调整页边距
					if(_can_save){
						$.each(_page_distance_arr,function(index,value){
							$("#resume_base").attr("data-modal_pagemargin",value);
							var _current_line_height = $(".wbdCv-resume").css({"height" : "auto"}).outerHeight();
							if(_current_line_height <= _resumePageHeight){
								return _can_save = false;
							}
						});
					}
					// 同步模块边距 页边距
					var  _data_modal_margin = $('#resume_base').attr("data-modal_margin"),
                    	_data_page_margin = $('#resume_base').attr("data-modal_pagemargin");
					// 模块边距
					if(_data_modal_margin){
						$("#margin_amount").val(_data_modal_margin);
						var math_modal_margin = (_data_modal_margin - 0) / 0.2 * (1 / 8).toFixed(4);
						var modal_margin_left = math_modal_margin * 100 + "%";
						$("#margin_slider .ui-slider-handle").css("left",modal_margin_left);
					}else{
						$("#margin_amount").val("1");
					}
					// 页边距
					if(_data_page_margin) {
						$('#page_margin li[data-value="'+  _data_page_margin +'"]').addClass('checked').siblings().removeClass('checked');
						if ($('#page_margin li.checked').length === 0) {
							$('#page_margin li:eq(0)').addClass('checked');
						}
					} else {
						$('#page_margin li:eq(0)').addClass('checked').siblings().removeClass('checked');
					}
					//是否能保存
					if(!_can_save){
						cvresume.main.delay_resume_save();
					}else{
						layer.msg("您的简历内容太多了，小丁无法帮您生成");
					}
					cvmutual.main.resume_page();
					// 调整结束 隐藏按钮  恢复状态
					$('.autopage_masking').fadeOut(100);
					$this.find('.roundToggleBtn').addClass('off');
				}, 800);
			});
			
			//获得焦点,保存原始操作内容
			$(document).on("focus","div[contenteditable='true']",function(e){
				cvresume.cur_opt_content=$(this).html();
			});
			//失去焦点就保存
			$(document).on("blur","div[contenteditable='true']",function(e){ 
				var html_content=$(this).html();
			    //焦点失去后，对去两者的内容是否有修改，如果有修改则保存
				if(cvresume.cur_opt_content==html_content){
					console.log("没有修改不用保存");
					return;
				}
				// 直接编辑姓名一句话同步到弹窗
				if ($(this).parents('#resume_name')) {
					$('#baseMsg-modal input[name="name"]').val($('#resume_name .name-con .name').text());
					$('#baseMsg-modal input[name="minSummary"]').val($('#resume_name .name-con .word').text());
				}
				//时间模块数据抽取
				try{
					var timeModules = ["resume_work","resume_internship","resume_volunteer","resume_project","resume_edu"];
					var id = $(this).closest(".moduleItem").attr("id");
					if($.inArray(id,timeModules) != -1&&!cvresume.main.is_empty(cvresume.info.resumeid)){
						cvresume.main.resume_save_time(id,$(this).closest(".moduleItemList"));
						return;
					}
				}catch(e){}
				cvresume.main.delay_resume_save();
			});
			// .save_opt
			$(document).on("click",".save_opt:not(.wbd-vip-lock)",function(){
				//简繁体切换标识
				var _id = $(this).attr("id");
				if(_id == "jian"){
					cvresume.info.resume_fontType_change = 0;
				}else if(_id == "fan"){
					cvresume.info.resume_fontType_change = 1;
				}else{
					cvresume.info.resume_fontType_change = -1;
				}
				cvresume.main.delay_resume_save();
			});
        	//判断简历类型
        	if($(".wbdCv-container").hasClass("mobile")){
        		cvresume.info.resume_type="手机";
        	}
        	//发布页切换简历类型点击事件
        	$("div.release_operation div.resume_type a").click(function(){
        		var _url = "/cvresume/" + cvresume.info.visitid + "/";
        		if(!$(this).hasClass("phone_resume")){
        			_url += "?device=wap";
        		}
        		location.href = _url;
			});
			// 免费会员点击出现升级页
			$(".vip_container .free").on('click', function(){
				common.main.vip_opt_tips();
			});
			// 手机简历模式下 手机视图垂直居中
			mobile_resume_middle();
			$(window).on('resize', mobile_resume_middle);
			function mobile_resume_middle(){
				if ($('.wbdCv-editorBody .wbdCv-container').hasClass('mobile')) {
					var mobile_resume_height = $('.wbdCv-container.mobile').height();
					var editor_height = $('.wbdCv-editorBody').height() <= 750 ? 750 : $('.wbdCv-editorBody').height();
					$('.wbdCv-container.mobile').css({
						'margin': ((editor_height - mobile_resume_height + 50) / 2) + 'px auto 0',
						'opacity': 1,
					});
				}
			}
	    },
	    init_:function(){//初始化
	    	cvresume.main.event_();
	    },
	    save_notice:function(save_status) {
	    	if(save_status == undefined)
	    		save_status = false;
	    	if(cvresume.save_trigger != save_status) {
	    		cvresume.save_trigger = save_status;
	    		if(save_status)
	    			$(window).unbind("beforeunload",cvresume.main.not_save_notice);
	    		else
	    			$(window).bind("beforeunload", cvresume.main.not_save_notice);
	    	}
	    },
	    not_save_notice:function(event) {
	    	return "你有修改内容没有保存，确定要离开吗？";
	    },
	    template_set:function(settings,resumeid){//模板配置渲染
	    	if(settings){
	    		var _classStr="#resume_base .wbdCv-base";	
	    		$(cvresume.info.sortPosition).each(function(i,item){//遍历方位
	    			var pos_set = settings[item.toLocaleLowerCase()];
	    			$(pos_set.reverse()).each(function(j,jtem){//reverse()素组翻转
	    				if(cvresume.main.is_empty(resumeid)){
							//隐藏
		    				if(!jtem.isShow){
								$("#"+jtem.key).addClass("hidden");
		    				}
	    				}
	    				//移位
	    				$(_classStr+item).prepend($("#"+jtem.key));
						var _class=$("#"+jtem.key).attr("data-parts");
		    			if(_class!=null&&_class!=""){
		    				$("#"+jtem.key).removeClass(_class).addClass("template_css").attr("data-parts","");
		    			}
	    			});
	    		});
	    	}
	    },
	    resume_save_time:function(type,target){//数据抽取-保存时间模块
	    	var time={};
    		var id = $(target).attr("data-id");
    		var beginTime = $(target).find("i.time-start").text();
			var endTime = $(target).find("i.time-end").text();
			var unit = $(target).find(".company").find("div[contenteditable]").html();
			var job = $(target).find(".post").find("div[contenteditable]").html();
			var content = $(target).find(".resume_content").html();
			
			if(!cvresume.main.timeModuleIsEmpty(beginTime) || 
				!cvresume.main.timeModuleIsEmpty(endTime) || 
				!cvresume.main.timeModuleIsEmpty(unit) ||
				!cvresume.main.timeModuleIsEmpty(job) || 
				!cvresume.main.timeModuleIsEmpty(content)){
				if(!cvresume.main.is_empty(id)){
					time["id"]=id;
				}
				//2019.12  | 2019.1
				var reg = /(^[1-9]\d{3}.[1-9]$)|(^[1-9]\d{3}.(0[1-9]|1[0-2])$)/;
				var regExp = new RegExp(reg);
				if((!cvresume.main.timeModuleIsEmpty(beginTime)&&!regExp.test(beginTime))
						||(!cvresume.main.timeModuleIsEmpty(endTime)&&(!regExp.test(endTime) && endTime !='至今' && endTime !='present'))){
					layer.msg('时间格式错误');
					return;
				}
				time["beginTime"]=beginTime;
    			time["endTime"]=endTime;
    			time["unit"]=unit;
    			time["job"]=job;
    			time["content"]=content;
    			if(!cvresume.module_save_trigger){
    				console.log("模块数据正在保存...");
    			}
    			var timeJson = JSON.stringify(time);
    			if(common.main.contain_emoji(timeJson)){
    				cvresume.main.delay_resume_save();
    				return;
    			}
    			cvresume.module_save_trigger=false;
    			$.ajax({
		    		type: "POST",
		            url: "/cvresume/module/time/save/",
		            data:{
		            	"resumeId":cvresume.info.resumeid,
		            	"type":type.replace("resume_", ""),
		            	"json":timeJson
		            },
		           	success:function(message){
		           		if(message.type == "success"){
			    			$(target).attr("data-id", message.content);
			    		}
	           	 	},
	           	 	complete:function(){
	           	 		cvresume.module_save_trigger=true;
	           	 		cvresume.main.delay_resume_save();
	           	 	}
		    	});
			}else if(!cvresume.main.is_empty(id)){//有id没数据,删除
				$.ajax({
		    		type: "POST",
		            url: "/cvresume/module/time/delete/",
		            data:{
		            	"resumeId":cvresume.info.resumeid,
		            	"type":type.replace("resume_", ""),
		            	"id":id
		            },
		           	success:function(message){
		           		if(message.type == "success"){
		    				$(target).removeAttr("data-id");
			    		}
	           	 	},
	           	 	complete:function(){
	           	 		cvresume.main.delay_resume_save();
	           	 	}
		    	});
			}else{
				cvresume.main.delay_resume_save();
			}
	    },
	    resume_save_recoment:function(item){//推荐信保存
	    	if(item.length<=0){
	    		layer.msg("推荐信保存出错，请刷新重试~");
	    		return;
	    	}
    		var recoment={};
    		var $e=item;
    		recoment["id"]=$e.attr("data-id");
    		recoment["name"]=$e.find(".name").find("div[contenteditable]").html();
    		recoment["mobile"]=$e.find(".contact_mobile").html();
    		recoment["content"]=$e.find(".resume_content").html();
	    	$.ajax({
	    		 type: "POST",
	             url: "/recommend/update/",
	             data:recoment,
	           	 success:function(message){
	           		 if(message.type!="success"){
	           			 layer.msg(message.content);
	           		 }
	           	 }
	    	});
	    },
	    resume_draw:function(itemid,resumeid,memberid,visitid){
			cvresume.info.itemid = itemid;
			cvresume.info.resumeid = resumeid;
			cvresume.info.memberid = memberid;
			cvresume.info.visitid = visitid;
	    },
	    set_language:function(language){
	    	cvresume.info.language = language;
	    },
	    delay_resume_save:function(s){
	    	if(cvresume.main.is_empty(s)){
	    		s=2000;
			}
			clearTimeout(cvresume.info.timeout_resume_save);
	    	cvresume.info.timeout_resume_save = setTimeout(function(){
	    		cvresume.main.resume_save();
	    	},s);
	    },
	    //isAsync:是否异步（默认true）
	    resume_save:function(isRelease, isAsync){//简历保存
	    	if(isAsync==undefined){
	    		isAsync=true;
	    	}
	    	var resume=cvresume.main.get_resume();
	    	var title = decodeURI(common.main.getUrlParamsValue("title"));
			if(!cvresume.main.is_empty(title) && title != "null"){
				resume["resume_title"]=title;
	    	}
	    	return cvresume.main.base_resume_save(isRelease, resume, isAsync);
	    },
	    //isAsync:是否异步（默认true）
	    base_resume_save:function(isRelease, resume, isAsync){//isRelease 控制history保存
	    	if(isAsync==undefined){
	    		isAsync=true;
	    	}
	    	if(isAsync && cvresume.resume_save_trigger){//异步并且可以保存
	    		cvresume.resume_save_trigger=false;
	    	}else if(isAsync && !cvresume.resume_save_trigger){//异步并且可以不可以保存
	    		console.log("简历数据正在保存...");
	    		return;
	    	}
	    	cvmutual.main.caclulate_resume_scale(resume);//计算简历进度
	    	var resumeSaveflag = cvresume.main.validate_resume(resume);//校验简历内容
	    	if(!resumeSaveflag){
	    		cvresume.resume_save_trigger = true;
	    		return false;
	    	}
	    	var _resumeJson = JSON.stringify(resume);
	    	//emojy表情拦截
	    	if(common.main.contain_emoji(_resumeJson)){
	    		layer.msg("不支持存储含emoji表情的简历数据,请清除后再进行保存");
	    		cvresume.resume_save_trigger = true;
	    		return false;
	    	}
	    	//简繁体切换标识
	    	if(cvresume.info.resume_fontType_change == 0){
	    		_resumeJson = resumeJson=$.t2s(_resumeJson);
	    	}else if(cvresume.info.resume_fontType_change == 1){
				_resumeJson = resumeJson=$.s2t(_resumeJson);
	    	}
	    	cvresume.info.resume_fontType_change = -1;

	    	var saveUrl="/cvresume/save/";
	    	$.ajax({type : "post",
	    		cache: false,
	    		async : isAsync,
	    		url : saveUrl,
	    		data : {"memberid" : cvresume.info.memberid, "itemid" :cvresume.info.itemid, "resumeid" :cvresume.info.resumeid,"json" : _resumeJson},
	    		beforeSend:function(){
	    			cvresume.main.resume_save_state('in');
	    		},
	    		success : function(message) {
	    			if(message.type == "success") {
	    				cvresume.main.save_notice(true);//移除提示
	    				resumeSaveflag= true;
	    				if(cvresume.main.isJsonFormat(message.content)){//首次保存
	    					var msg_content = cvresume.main.strToJson(message.content);
	    					cvresume.main.resume_draw(msg_content.itemid,msg_content.resumeid,msg_content.memberid,msg_content.visitid);
	    					var data_url=wbdcnf.base +'/cvresume/edit/?itemid='+msg_content.itemid+'&resumeId='+msg_content.resumeid;
	    					history.pushState(null,"简历首次保存",data_url);
	    					//编辑器切换地址
	    					$(".wapresume .tips a[href]").attr("href", $(".wapresume .tips a[href]").attr("href")+'&resumeId='+msg_content.resumeid);
	    					common.main.resumeOperationLogUpload(cvresume.info.resumeid,"create","","");//日志上报
	    					//内容模板使用数据累加
	    					if(cvresume.info.resumecontentid!=0&&!cvresume.main.is_empty(cvresume.info.resumecontentid)){
	    						$.post("/cvresume/resume_content/post_use_num/",{"rcid":cvresume.info.resumecontentid},function(){});
	    					}
	    				}else{
	    					//打点简历修改数据
	    					cvresume.main._500dtongji("PC-简历-修改简历");
	    				}
	    				setTimeout(function(){
		    	    		cvresume.main.resume_save_state('success');
		    	    		cvresume.main.resume_save_history();
		    	    	},1000);
	    				cvresume.main.gernateResumeWapQrCodeImage(cvresume.info.resumeid);//自动手机简历二维码
	    			}else{
	    				if(message.content=="已超过最大简历创建数量，请升级会员继续"){
	    					if(cvresume.save_trigger){//只提示一次VIP
	    						common.main.resume_confirm({
									title:"VIP会员升级提示",
									modal_class:"vip-content",
									content:"超出最大创建简历数量，请删除部分简历或升级会员后继续",
									ok:"立即升级",
									onOk:function(){
										common.main.vip_opt_tips();
									}
								});
	    					}else{
	    						layer.msg(message.content);
	    					}
	    				}else if(message.content=="没有登录！"){
	    					setTimeout(function(){
	    						layer.msg(message.content);
			    	    	 },1000*60);
	    				}else if(message.content=="保存数据异常"){
	    					common.main.resume_confirm({
								title:"提示",
								content:"保存简历数据异常～请联系客服人员"
							});
	    				}else{
	    					layer.msg(message.content);
	    				}
	    				cvresume.main.save_notice(false);//添加提示
	    				cvresume.main.resume_save_state('error');
	    			}
	    			cvresume.resume_save_trigger=true;
	    		},
	    		error:function(){
	    			cvresume.main.resume_save_state('error');
	    			cvresume.resume_save_trigger=true;
	    		}
	    	});
	    	return resumeSaveflag;
		},
		resume_save_state: function(state){
			switch (String(state)) {
				case 'success':
					$(".liveupdate").removeClass('in_save').find("span").css("color","#00c190").text(common.main.date_format(new Date(),"HH:mm")+" 保存成功");
					break;
				case 'error':
					$(".liveupdate").removeClass('in_save').find("span").css("color","red").text(common.main.date_format(new Date(),"HH:mm")+" 保存失败");
					break;
				case 'in':
					$(".liveupdate").addClass('in_save').find("span").css("color","#00c190").text("正在保存...");
					break;
			}
		},
	    get_resume:function(){//获取保存数据
	    	var resume={};
	    	resume=cvresume.main.get_resume_title(resume);//简历名称
	    	resume=cvresume.main.get_resume_scale(resume);//简历修改比例
	    	resume=cvresume.main.get_resume_language(resume);//中英文简历
	    	resume=cvresume.main.get_resume_set(resume);//简历设置信息，主题，字体，字体大小，字体间距，简繁体
	    	resume=cvresume.main.get_resume_modul_mg(resume);//模块管理信息
	    	resume=cvresume.main.get_resume_icon_map(resume);//图标管理
	    	resume=cvresume.main.get_resume_cover_info(resume);//封面信息
	    	resume=cvresume.main.get_resume_letter(resume);//自荐信
	    	resume=cvresume.main.get_resume_head(resume);//头像
	    	resume=cvresume.main.get_resume_base_info(resume);//基本信息
	    	resume=cvresume.main.get_resume_job_preference(resume);//求职意向
	    	resume=cvresume.main.get_resume_skill(resume);//技能特长
	    	resume=cvresume.main.get_resume_hobby(resume);//兴趣爱好
	    	resume=cvresume.main.get_resume_time_module(resume, "#resume_edu");//教育背景
	    	resume=cvresume.main.get_resume_time_module(resume, "#resume_work");//工作经历
	    	resume=cvresume.main.get_resume_time_module(resume, "#resume_internship");//实习经历
	    	resume=cvresume.main.get_resume_time_module(resume, "#resume_volunteer");//志愿者经历
	    	resume=cvresume.main.get_resume_time_module(resume, "#resume_project");//项目经历
	    	resume=cvresume.main.get_resume_summary(resume);//自我评价
	    	resume=cvresume.main.get_resume_honor(resume);//荣誉证书
	    	resume=cvresume.main.get_resume_portfolio(resume);//作品集
	    	resume=cvresume.main.get_resume_custom(resume);//自定项
	    	resume=cvresume.main.get_resume_sort(resume);//模块排序信息
	    	resume=cvresume.main.get_resume_contact(resume);//联系我样本保存
			resume=cvresume.main.get_resume_qrcode(resume);//手机二维码
			resume=cvresume.main.get_resume_moduletag(resume);// 模块
	    	return resume;
	    },
    	validate_resume:function(resume){//校验简历Json串
    		var isPass = true;
    		//主要模块
    		var main_modules = {"resume_head":"头像",
    							"resume_job_preference":"求职意向",
    							"resume_edu":"教育背景",
    							"resume_internship":"实习经验",
    							"resume_volunteer":"自愿者经历",
    							"resume_project":"项目经验",
    							"resume_work":"工作经验",
    							"resume_honor":"奖项荣誉",
    							"resume_summary":"自我评价",
    							"resume_portfolio":"作品集",
    							"resume_hobby":"个人标签",
    							"resume_skill":"技能特长",
    							"resume_qrcode":"二维码",
    							};
    		//模块管理信息校验
    		$.each(main_modules,function(key,value){
    			if(!cvresume.main.isResumeMgFormat(resume.modul_show[key])){
    				layer.msg(value + "模块信息格式有误");
    				return isPass = false;
    			}
    		});
    		//模块内容校验
    		//封面
    		var resume_cover_json = JSON.stringify(resume.resume_cover);
    		if(resume_cover_json.length > 255){
    			layer.msg("封面内容长度超过最大限制");
    			isPass = false;
    		}
    		//头像
    		var resume_head = resume["resume_head"];
    		if(resume["resume_head"].length > 255 || !/^(((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+|\/)([\w\-\.,@?^=%&:\/~\+#]*[\w\-\@?^=%&\/~\+#])?$/.test(resume_head)){
    			layer.msg("头像链接异常");
				isPass = false;
    		}
    		return isPass;
    	},
	    get_resume_title:function(resume){//简历命名
	    	var resume_title = $("#resumeName_value").val();
	    	if(!cvresume.main.is_empty(resume_title)){
	    		resume["resume_title"]=resume_title;
	    	}
	    	return resume
	    },
	    get_resume_scale:function(resume){//简历修改比例
	    	resume["resume_scale"] = $('.diagnose_defalut .diagnose_score').attr("data-value");
	    	return resume
	    },
	    get_resume_language:function(resume){//中英文简历
	    	resume["resume_language"]=cvresume.info.language;
	    	return resume
	    },
	    get_resume_set:function(resume){//获取简历设置信息
	    	var resume_set={};
	    	//获取颜色
	    	var color=$("#resume_base").attr("data_color");
	    	if(!cvresume.main.is_empty(color)){
	    		resume_set["color"]=color;
	    	}
	    	//获取字体
	    	var font=$("#resume_base").attr("data_font_name");
	    	if(!cvresume.main.is_empty(font)){
	    		resume_set["font"]=font;
	    	}
	    	//获取字体大小
	    	var fontSize=$("#resume_base").attr("data_font_size");
	    	if(!cvresume.main.is_empty(fontSize)){
	    		resume_set["fontSize"]=fontSize;
	    	}
	    	//获取行距
	    	var padding=$("#resume_base").attr("data_line_height");
	    	if(!cvresume.main.is_empty(padding)){
	    		resume_set["padding"]=padding;
	    	}
	    	//获取块距
	    	var margin=$("#resume_base").attr("data-modal_margin");
	    	if(!cvresume.main.is_empty(margin)){
	    		resume_set["margin"]=margin;
	    	}
	    	//获取页边距
	    	var pageMargin=$("#resume_base").attr("data-modal_pageMargin");
	    	if(!cvresume.main.is_empty(pageMargin)){
	    		resume_set["pageMargin"]=pageMargin;
			}
			// attr 扩展字段
			var attr = {};
			// 分页隐藏状态
			var pagingHidden = $('#resume_base').attr('data_hidden_paging');
			attr['resume_hidden_paging'] = cvresume.main.is_empty(pagingHidden) ? false : pagingHidden;

			resume_set['attr'] = attr;
	    	resume["resume_set"]=resume_set;
	    	//获取字体类别
	    	var fontType=$("#resume_base").attr("data_font_type");
	    	if(!cvresume.main.is_empty(fontType)){
	    		resume_set["fontType"]=fontType;
	    	}
	    	return resume;
	    },
		get_resume_modul_mg:function(resume){//获取模块管理信息
			var modul_show={};
			//获取自荐信是否显示
			if($("#resume_letter").length == 0 || $("#resume_letter").hasClass("hidden")){
				modul_show["letterShow"]=false;
			}else{
				modul_show["letterShow"]=true;
			}
			//是否封面是否显示
			if($("#resume_cover").length == 0 || $("#resume_cover").hasClass("hidden")){
				modul_show["coverShow"]=false;
			}else{
				modul_show["coverShow"]=true;
			}
			//个人照片是否显示
			if($("#resume_head").hasClass("hidden")){
				modul_show["headShow"]=false;
			}else{
				modul_show["headShow"]=true;
			}
			//联系我是否显示
			if($("#resume_contact").hasClass("hidden")){
				modul_show["contactShow"]=false;
			}else{
				modul_show["contactShow"]=true;
			}			
			//模块配置信息抽取
			var $all_modul=$("#resume_base").find(".moduleItem");
			 
			$all_modul.each(function(index,ele){
				var $ele=$(ele);
				var set_config={};
				var key=$ele.attr("id");
				if(cvresume.main.is_empty(key)){
					return true;
				}
				//模块是否显示
				if($ele.hasClass("hidden")){
					set_config["isShow"]=false;
				}else{
					set_config["isShow"]=true;
				}
				//标题是否显示
				if($ele.find(".hiddenTitle s").hasClass("checked")){
					set_config["isTitleShow"]=false;
				}else{
					set_config["isTitleShow"]=true;
				}
				//时间是否显示
				if($ele.find(".hiddenTime s").hasClass("checked")){
					set_config["isTimeShow"]=false;
				}else{
					set_config["isTimeShow"]=true;
				}
				//内容是否显示
				if($ele.find(".hiddenText s").hasClass("checked")){
					set_config["isContentShow"]=false;
				}else{
					set_config["isContentShow"]=true;
				}
				//标题
				var $ele_title=$ele.find(".module_item_title");
				set_config["title"]=$ele_title.html().replace(/<\/?[^>]*>/g,'');//清除html标签
				//样式
				var $ele_class=$ele.attr("data-parts");
				if($ele_class!=null&&$ele_class!=""){
					if(cvresume.info.resume_type=="手机"){
						set_config["wapModelStyle"]=$ele_class;
					}else{
						set_config["docModelStyle"]=$ele_class;
					}
				}
				if ($ele.attr('id') === 'resume_qrcode') {
					// 模块位置 left top  目前只有二维码用到
					if ($ele.attr('data-point')) {
						set_config['point'] = $ele.attr('data-point');
					}
					// 模块缩放尺寸 等比 width  目前只有二维码用到
					if ($ele.attr('data-width')) {
						set_config['width'] = $ele.attr('data-width');
					}
				}
				set_config["key"]=key;
				modul_show[key]=set_config;
			});
			resume["modul_show"]=modul_show;
	    	return resume;
	    },
	    set_copyToClipBoard:function (str) {
	        //复制到剪贴板
	    	 var copyInput = $("<input type='text' value='"+ str +"' style='opacity:1;position:absolute;top:20px;z-index:999;' id='copyText'>");
	         $(".in").length >0 ? dom = $(".in")[0] : dom = "body"
	         copyInput.appendTo(dom);
	         document.getElementById("copyText").select();
	         document.execCommand("copy",false,null)
	         $("#copyText").remove();
	    },
	    get_resume_icon_map:function(resume){//图标
	    	var $all_icon=$("#resume_base").find("a.divIconFont");
	    	var iconFontMap={};
	    	$all_icon.each(function(index,ele){
	    		var key=$(ele).attr("for-key");
	    		if(cvresume.main.is_empty(key)){
	    			return true;
				}
				var icon;
				if ($(ele).children('svg').length > 0) {
					icon = $(ele).find('use').attr('xlink:href');
				} else {
					icon=$(ele).html();
				}
		    	iconFontMap[key]=icon;
	    	});
	    	resume["iconFontMap"]=iconFontMap;
	    	return resume;
	    },
	    get_resume_cover_info:function(resume){//获取封面信息
	    	var cover_info=new Array();
	    	var $allList=$("#resume_cover").find(".moduleItemList");
	    	$allList.each(function(index,ele){
	    		var info={};
	    		var info_icon=$(ele).find(".divIconFont").html();
	    		var info_content=$(ele).find('div[contenteditable="true"]').html();
	    		if(!cvresume.main.is_empty(info_content)){
					info["icon"]=info_icon;
		    		info["content"]=info_content;
		    		cover_info.push(info);
	    		}
	    	});
	    	resume["resume_cover"]=cover_info;
	    	return resume;
	    },
	    get_resume_letter:function(resume){//获取自荐信信息
	    	var letter=$("#resume_letter").find('div[contenteditable="true"]').html();
	    	if(!cvresume.main.is_empty(letter)){
	    		resume["resume_letter"]=letter;
	    	}
	    	return resume;
	    },
	    get_resume_head:function(resume){
	    	var head=$("#resume_head").find('.img-preview img').attr("src");
	    	var _size=$("#resume_head").attr("data-size");
	    	if(!cvresume.main.is_empty(head)){
	    		resume["resume_head"]=head;
	    		resume["resume_headType"]=_size;
	    	}
	    	return resume;
		},
	    get_resume_base_info:function(resume){//获取基本信息--从弹框里获取
	    	var $baseMsg=$("#baseMsg-modal");
	    	var resume_base={};
	    	var base_name=$baseMsg.find('input[name="name"]').val();//姓名
			var base_minSummary=$baseMsg.find('input[name="minSummary"]').val();//简单介绍语
			var base_minSummary_show = $baseMsg.find('.roundToggleBtn[data-panel="minSummaryShow"]').hasClass('off');
	    	//个人基本信息
	    	var base_birth=$baseMsg.find('input[name="birth"]').val();
	    	var base_city=$baseMsg.find('input[name="city"]').val();
	    	var base_cityName=$baseMsg.find('input[name="city"]').attr("data-name");
	    	var base_jobYear=$baseMsg.find('input[name="jobYear"]').val();
	    	var base_mobile=$baseMsg.find('input[name="mobile"]').val().trim();
	    	var base_email=$baseMsg.find('input[name="email"]').val();
	    	var base_sex=!cvresume.main.is_empty($baseMsg.find('input[name="sex"]:checked').val()) ? $baseMsg.find('input[name="sex"]:checked').val() : "";
	    	var base_education=$baseMsg.find('input[name="education"]').val();
	    	var base_nation=$baseMsg.find('input[name="nation"]').val();
	    	var base_marriageStatus=$baseMsg.find('input[name="marriageStatus"]').val();
	    	var base_politicalStatus=$baseMsg.find('input[name="politicalStatus"]').val();
	    	var base_height=$baseMsg.find('input[name="height"]').val();
	    	var base_weight=$baseMsg.find('input[name="weight"]').val();
	    	if(!cvresume.main.is_empty(base_name)){
	    		resume_base["name"]=base_name;
			}
			// 一句话描述
			resume_base["minSummary"] = {
				'content': base_minSummary,
				'isShow': base_minSummary_show,
			};

	    	if(!cvresume.main.is_empty(base_birth)){
	    		resume_base["birth"]=base_birth;
	    	}
	    	if(!cvresume.main.is_empty(base_city)){
	    		resume_base["city"]=base_city;
	    	}
	    	if(!cvresume.main.is_empty(base_cityName)){
	    		resume_base["cityName"]=base_cityName;
	    	}
	    	if(!cvresume.main.is_empty(base_jobYear)){
	    		resume_base["jobYear"]=base_jobYear;
	    	}
	    	if(!cvresume.main.is_empty(base_mobile)){
	    		resume_base["mobile"]=base_mobile;
	    	}
	    	if(!cvresume.main.is_empty(base_email)){
	    		resume_base["email"]=base_email;
	    	}
	    	if(!cvresume.main.is_empty(base_sex)){
	    		resume_base["sex"]=base_sex;
	    	}
	    	if(!cvresume.main.is_empty(base_education)){
	    		resume_base["education"]=base_education;
	    	}
	    	if(!cvresume.main.is_empty(base_nation)){
	    		resume_base["nation"]=base_nation;
	    	}
	    	if(!cvresume.main.is_empty(base_marriageStatus)){
	    		resume_base["marriageStatus"]=base_marriageStatus;
	    	}
	    	if(!cvresume.main.is_empty(base_politicalStatus)){
	    		resume_base["politicalStatus"]=base_politicalStatus;
	    	}
	    	if(!cvresume.main.is_empty(base_height)){
	    		resume_base["height"]=base_height;
	    	}
	    	if(!cvresume.main.is_empty(base_weight)){
	    		resume_base["weight"]=base_weight;
	    	}
	    	//个人自定义信息
	    	var $customMsg=$baseMsg.find('.defindItem').find('[data-panel="defind"]');
	    	var msgArray=new Array();
	    	$customMsg.each(function(index,ele){
	    		var custommsg={};
	    		var custommsg_key=$(ele).attr("data-value");
	    		var custommsg_name=$(ele).find(".defindName").val();
	    		var custommsg_desc=$(ele).find(".defindContent").val();
	    		if(!cvresume.main.is_empty(custommsg_desc)){
	    			custommsg["key"]=custommsg_key;
		    		custommsg["name"]=custommsg_name;
		    		custommsg["desc"]=custommsg_desc;
		    		msgArray.push(custommsg);
	    		}
	    	});
	    	resume_base["customMsg"]=msgArray;
	    	//个人网站
	    	var $homePages=$baseMsg.find('[data-panel="homePage"]');
	    	var homeArray=new Array();
	    	$homePages.each(function(index,ele){
	    		var home={};
	    		var home_key=$(ele).attr("data-value");
	    		var home_url=$(ele).find("[name='homeUrl']").val();
	    		var home_desc=$(ele).find("[name='homeDesc']").val();
	    		if(!cvresume.main.is_empty(home_url) || !cvresume.main.is_empty(home_desc)){
	    			home["key"]=home_key;
		    		home["url"]=home_url;
		    		home["desc"]=home_desc;
		    		homeArray.push(home);
	    		}
	    	});
	    	resume_base["customWebsite"]=homeArray;
	    	resume["resume_base_info"]=resume_base;
	    	return resume;
	    },
	    get_resume_job_preference:function(resume){//求职意向
	    	var job_preference={};
	    	var $jobIntension=$("#jobIntension-modal");
			var jp_jobFunction=$jobIntension.find('input[name="jobFunction"]').val();
	    	var jp_jobType=$jobIntension.find('input[name="jobType"]').val();
	    	var jp_jobTime=$jobIntension.find('input[name="jobTime"]').val();
	    	var jp_jobCity=$jobIntension.find('input[name="jobCity"]').val();
	    	var jp_jobCityName=$jobIntension.find('input[name="jobCity"]').attr("data-name");
	    	var jp_jobMinSalary=$jobIntension.find('input[name="jobMinSalary"]').val();
	    	var jp_jobMaxSalary=$jobIntension.find('input[name="jobMaxSalary"]').val();
	    	var jp_jobSalary=$jobIntension.find('input[name="jobSalary"]').val();
	    	var jp_negotiable=$jobIntension.find('input[name="negotiable"]').prop("checked");
			if(!cvresume.main.is_empty(jp_jobFunction)){
				job_preference["jobFunction"]=jp_jobFunction;
			}
			if(!cvresume.main.is_empty(jp_jobType)){
				job_preference["jobType"]=jp_jobType;
			}
			if(!cvresume.main.is_empty(jp_jobTime)){
				job_preference["jobTime"]=jp_jobTime;
			}
			if(!cvresume.main.is_empty(jp_jobCity)){
				job_preference["jobCity"]=jp_jobCity;
			}
			if(!cvresume.main.is_empty(jp_jobCityName)){
				job_preference["jobCityName"]=jp_jobCityName;
			}
			if(!cvresume.main.is_empty(jp_jobType) && jp_jobType=="partTime"){
				if(!cvresume.main.is_empty(jp_jobSalary)){
					job_preference["jobMinSalary"]=job_preference["jobMaxSalary"]=jp_jobSalary;
				}
			}else{
				if(!cvresume.main.is_empty(jp_jobMinSalary)){
					job_preference["jobMinSalary"]=jp_jobMinSalary;
				}
				if(!cvresume.main.is_empty(jp_jobMaxSalary)){
					job_preference["jobMaxSalary"]=jp_jobMaxSalary;
				}
			}
			if(jp_negotiable){
				job_preference["jobMinSalary"] = 0;
				job_preference["jobMaxSalary"] = 0;
			}
	    	resume["resume_job_preference"]=job_preference;
	    	return resume;
	    },
	    get_resume_skill:function(resume){//技能特长
	    	var $skill=$("#resume_skill");
	    	var $allmoduleItemList=$skill.find(".moduleItemList");
	    	var skillArray=new Array();
	    	$allmoduleItemList.each(function(i,e){
	    		var skillItem={};
	    		skillItem["name"]=$(e).find(".item_title").text();
	    		if(!cvresume.main.is_empty($(e).attr("data-id"))){
	    			skillItem["id"]=$(e).attr("data-id");
	    		}
	    		skillItem["masterLevel"]=$(e).find(".item_level").attr("data_level");
	    		skillItem["masterLevelDesc"]=$(e).find(".item_level span").text();
	    		skillArray.push(skillItem);
	    	});
	    	resume["resume_skill"]=skillArray;
	    	return resume;
	    },
	    get_resume_hobby:function(resume){//兴趣爱好
	    	var $hobby=$("#resume_hobby");
	    	var $allmoduleItemList=$hobby.find(".moduleItemList");
	    	var hobbyArray=new Array();
	    	$allmoduleItemList.each(function(i,e){
	    		var hobbyItem={};
	    		hobbyItem["key"]=$(e).attr("id");
	    		if(!cvresume.main.is_empty($(e).attr("data-id"))){
	    			hobbyItem["id"]=$(e).attr("data-id");
	    		}
	    		hobbyItem["name"]=$(e).find(".item_title").text();
	    		hobbyArray.push(hobbyItem);
	    	});
	    	resume["resume_hobby"]=hobbyArray;
	    	return resume;
	    },
	    get_resume_time_module:function(resume,id){//时间模块数据抓取（教育背景、工作经历、实习经历、志愿者经历、项目经历）
	    	var $module=$(id);
	    	var key=$module.attr("id");
	    	var timeItemArray = new Array();
	    	var $allmoduleItemList=$module.find(".moduleItemList");
	    	$allmoduleItemList.each(function(i,e){
	    		var timeItem={};
	    		var id = $(e).attr("data-id");
	    		var beginTime = $(e).find("i.time-start").text();
    			var endTime = $(e).find("i.time-end").text();
    			var unit = $(e).find(".company").find("div[contenteditable]").html();
    			var job = $(e).find(".post").find("div[contenteditable]").html();
    			var content = $(e).find(".resume_content").html();
    			if(!cvresume.main.timeModuleIsEmpty(beginTime) || 
    				!cvresume.main.timeModuleIsEmpty(endTime) || 
    				!cvresume.main.timeModuleIsEmpty(unit) ||
    				!cvresume.main.timeModuleIsEmpty(job) || 
    				!cvresume.main.timeModuleIsEmpty(content)){
    				if(!cvresume.main.is_empty(id)){
						timeItem["id"]=id;
    				}
    				timeItem["beginTime"]=beginTime;
	    			timeItem["endTime"]=endTime;
	    			timeItem["unit"]=unit;
	    			timeItem["job"]=job;
	    			timeItem["content"]=content;
	    			timeItemArray.push(timeItem);
    			}
	    	});
	    	resume[key]=timeItemArray;
	    	return resume;
	    },
	    get_resume_summary:function(resume){//自我评价模块
	    	var summary=$("#resume_summary").find(".moduleItemList").find("div.resume_content").html();
	    	if(!cvresume.main.is_empty(summary)){
	    		resume["resume_summary"]=summary;
			}
	    	return resume;
	    },
	    get_resume_honor:function(resume){//奖项荣誉
	    	var honor=$("#resume_honor").find(".moduleItemList").find("div.resume_content").html();
	    	if(!cvresume.main.is_empty(honor)){
	    		resume["resume_honor"]=honor;
	    	}
	    	return resume;
	    },
	    get_resume_portfolio:function(resume){//作品展示
	    	var $resume_portfolio=$("#resume_portfolio");
	    	var $allmoduleItemList=$resume_portfolio.find(".moduleItemList");
	    	var portfolio={};
	    	var portfolio_imgArray=new Array();
	    	var portfolio_linkArray=new Array();
	    	$allmoduleItemList.each(function(index,ele){
	    		var $ele=$(ele);
	    		var portfolioTemp={};
	    		portfolioTemp["title"]=$ele.find(".work-title").html();
	    		portfolioTemp["desc"]=$ele.find(".work-text").html();
	    		if($ele.find(".work-img").length>0){//图片
	    		  portfolioTemp["img"]=$ele.find(".work-img").find("img").attr("src");
	    		  portfolio_imgArray.push(portfolioTemp);
	    		}else{//地址使用title存放
				  portfolio_linkArray.push(portfolioTemp);
	    		}
	    	});
	    	portfolio["img"]=portfolio_imgArray;
	    	portfolio["link"]=portfolio_linkArray;
	    	resume["resume_portfolio"]=portfolio;
	    	return resume;
	    },
	    get_resume_custom:function(resume){//自定义模块
	    	var resume_customs=new Array();
	    	var $resume_customs=$(".customItem");
	    	$resume_customs.each(function(index,ele){
				var $ele=$(ele);
				var custom={};
				custom["key"]=$ele.attr("id");//key
				//var position=$ele.parent().attr("id");
				//custom["position"]=!cvresume.main.is_empty(position) && position == "bar" ? "right" : "left";//位置
				if($ele.find(".hiddenTitle s").hasClass("checked")){//标题是否隐藏
					custom["isTitleShow"]=false;
				}else{
					custom["isTitleShow"]=true;
				}
				if($ele.find(".hiddenTime s").hasClass("checked")){//时间模块是否隐藏
					custom["isTimeShow"]=false;
				}else{
					 custom["isTimeShow"]=true;
				}
				if($ele.find(".hiddenText s").hasClass("checked")){//描述是否隐藏
					custom["isContentShow"]=false;
				}else{
					custom["isContentShow"]=true;
				}
				var $ele_title=$ele.find(".module_item_title");

				custom["title"]=$ele_title.html();
				if($ele.hasClass("descItem")){//描述模块
					custom["content"]=$ele.find(".resume_content").html();
				}else{//经验模块
					var timeItemArray=new Array();
					var $allmoduleItemList=$ele.find(".moduleItemList");
		    		$allmoduleItemList.each(function(i,e){
			    		var timeItem={};
			    		timeItem["beginTime"]=$(e).find("i.time-start").text();
			    		timeItem["endTime"]=$(e).find("i.time-end").text();
			    		timeItem["unit"]=$(e).find(".company").find("div[contenteditable]").html();
			    		timeItem["job"]=$(e).find(".post").find("div[contenteditable]").html();
			    		timeItem["content"]=$(e).find(".resume_content").html();
			    		timeItemArray.push(timeItem);
			         });
					 custom["itemList"]=timeItemArray;
				 }
				 var $ele_class=$ele.attr("data-parts");
				 if($ele_class!=null&&$ele_class!=""){
					if(cvresume.info.resume_type=="手机"){
						custom["wapModelStyle"]=$ele_class;
					}else{
						custom["docModelStyle"]=$ele_class;
					}
				}
				 resume_customs.push(custom);
	    	});
			resume["custom"]=resume_customs;
	    	return resume;
	    },
	    get_resume_contact:function(resume){//联系我
	    	var contact={};
	    	var $resume_contact=$("#resume_contact");
	    	var contact_name=$resume_contact.find(".resume_contact_name").html();
	    	var contact_desc=$resume_contact.find(".resume_contact_desc").html();
	    	var contact_contact=$resume_contact.find(".resume_contact_mobile").html();
	    	var contact_content=$resume_contact.find(".resume_contact_content").html();
	    	if(!cvresume.main.is_empty(contact_name) || 
	    		!cvresume.main.is_empty(contact_desc) ||
	    		!cvresume.main.is_empty(contact_contact) ||
	    		!cvresume.main.is_empty(contact_content)){
	    		contact["name"]=contact_name;
	    		contact["desc"]=contact_desc;
	    		contact["contact"]=contact_contact;
	    		contact["content"]=contact_content;
	    	}
	    	resume["resume_contact"]=contact;
	    	return resume;
	    },
	    get_resume_qrcode:function(resume){//二维码
	    	var qrcode={};
			var $qrcode=$("#resume_qrcode");
			qrcode["qrcodeTips"]=$qrcode.find(".resume_content").html();
	    	resume["resume_qrcode"]=qrcode;
	    	return resume;
	    },
	    get_resume_sort:function(resume){//模块排序
	    	var sort = {};
	    	var _classStr="#resume_base .wbdCv-base";
	    	$(cvresume.info.sortPosition).each(function(index,item){
	    		var arr=[];
	    		$($(_classStr+item+" .resume_sort")).each(function(index,ele){
	    			arr.push($(ele).attr("id"));
	    		});
	    		sort[item.toLocaleLowerCase()] = arr;
	    	});
	    	resume["sort"] = sort;
	    	return resume;
		},
		get_resume_moduletag: function(resume){
			var module_tag = {};
			// 只有这6个模块才存在模块标签  过滤空内容
			$('#resume_edu:visible, #resume_work:visible, #resume_internship:visible, #resume_volunteer:visible, #resume_project:visible, #resume_summary:visible').each(function(module_index, module_item){
				var $id = $(module_item).attr('id');
				var tag_arr = [];
				$(module_item).find('.moduleItemList').each(function(modulelist_index, modulelist_item){
					var tag_string = [];
					$(modulelist_item).find('span.moduleTags').each(function(tag_index, tag_item){
						if ($(tag_item).text().replace(/\s+/g, '') !== '') {
							tag_string.push($(tag_item).text());
						}
					});
					if (tag_string.join(',') !== '') {
						tag_arr.push(tag_string.join(','));
					} else {
						tag_arr.push('');
					}
				});
				module_tag[$id] = tag_arr;
			});
			resume['module_tags'] = module_tag;
			return resume;
		}, 
	    get_resume_recoment:function(){//推荐信
	    	var $recoments=$("#resume_recoment");
	    	var recomentArray=new Array();
	    	var $recomentItem=$recoments.find(".moduleItemList");
	    	$recomentItem.each(function(index,ele){
	    		var recoment={};
	    		var $e=$(ele);
	    		recoment["id"]=$e.attr("data-id");
	    		recoment["name"]=$e.find(".name").find("div[contenteditable]").html();
	    		recoment["contactType"]=$e.find(".contact_type").html();
	    		recoment["mobile"]=$e.find(".contact_mobile").html();
	    		recoment["relative"]=$e.find(".relation").find("div[contenteditable]").html();
	    		recoment["time"]=$e.find(".time").find("div[contenteditable]").html();
	    		recoment["content"]=$e.find(".resume_content").html();
	    		recomentArray.push(recoment);
	    	});
	    	return recomentArray;
	    },
	    set_cvresume_info:function(itemid,resumeid,memberid){//简历id,模板ID，会员id设置
	    	if(!cvresume.main.is_empty(itemid)){
	    		cvresume.main.info.itemid=itemid;
	    	}
	    	if(!cvresume.main.is_empty(resumeid)){
	    		cvresume.main.info.resumeid=resumeid;
	    	}
	    	if(!cvresume.main.is_empty(memberid)){
	    		cvresume.main.info.memberid=memberid;
	    	}
	    },
	    resume_sort:function(sort){//简历初始排序(sort:排序配置)
	    	if(sort){
	    		var _classStr="#resume_base .wbdCv-base";	
	    		$(cvresume.info.sortPosition).each(function(i,item){//遍历方位
	    			var pos = sort[item.toLocaleLowerCase()];
	    			$(pos.reverse()).each(function(j,jtem){//遍历各方位的id，reverse()素组翻转
	    				$(_classStr+item).prepend($("#"+jtem));//在所在方位的div开头添加节点
	    			});
	    		});
	    	}
	    },
	    get_resume_history:function(){//获取简历历史记录
	    	$.get("/resume/history/list/",{"itemid" :cvresume.info.itemid,"resumeId" :cvresume.info.resumeid},function(message){
	    		if($(message).filter("li").length>0){
	    			$("#historyModal .czls-null").hide();	
	    		}
	    		message = message.replace(/\{0}/g, cvresume.info.resume_type);
	    		$("#historyModal ul").html(message);
			});
	    },	    
	    resume_save_history:function(){//保存简历历史记录
	    	if(!window.sessionStorage){
	    		return;
	    	}
	    	var _history = window.sessionStorage.getItem("history");
	    	var _historyid;
	    	var _historyResumeid;
	    	if(!cvresume.main.is_empty(_history)){
	    		_historyid = _history.split(",")[0];
	    		_historyResumeid = _history.split(",")[1];
	    		if(_historyResumeid == cvresume.info.resumeid){
	    			return;
	    		}else{
	    			_historyid = '';
	    		}
	    	}
	    	var _resume = cvresume.main.get_resume();
			var _scale = _resume['resume_scale'];
			if(_scale > 20 && cvresume.history_save_trigger){
                cvresume.history_save_trigger = false;
				$.ajax({
					type : "POST",
		    		url : "/resume/history/save/",
		    		data : {
						"historyid":_historyid,
						"resumeId" :cvresume.info.resumeid,
						"json" : JSON.stringify(_resume)
		    		},
		    		success : function(message) {
		    			var _type = message.type;
		    			var _content = message.content;
		    			if(_type == "success"){
		    				window.sessionStorage.setItem("history", _content + "," + cvresume.info.resumeid);
		    			}
		    		},
		    		complate : function(){
		    			cvresume.history_save_trigger = true;
		    		}
		    	});
			}
	    },
	    resume_preview_history:function(id,type){//简历历史记录预览
	    	window.open("/resume/history/preview/" + type + "/" + id + "/");
	    },
	    resume_preview_pageInit:function(){//简历预览页面初始化
	    	$("div[contenteditable]").attr("contenteditable","false");//可编辑状态为false
	    	$(".baseItem-null").attr("style","display:none;");//自定义框隐藏
	    	//求职意向图标去除
	    	$("#resume_job_preference .moduleItemList").each(function(id,item){
	    		var _span = $(item).find("span").text();
	    		if(cvresume.main.is_empty(_span)){
	    			$(this).attr("style","display:none");
	    		}
	    	});
	    },
	    resume_release_pageInit:function(){//简历发布页面初始化
	    	$(document).off("blur","div[contenteditable='true']");//去除失去焦点保存
	    	$("div[contenteditable='true']").off("blur");
	    	$("div[contenteditable]").attr("contenteditable","false");//可编辑状态为false
	    	$(".baseItem-null").attr("style","display:none;");//自定义框隐藏
			$("#resume_contact").find("div[contenteditable]:gt(0)").attr("contenteditable","true");//联系我可编辑状态
            if($(".wbdCv-baseStyle").parents('.mobile').length === 0){
				// 第三方查看页高度自适应
				if ($('.cv-preview').length > 0) {
					var resumePageHtml = '<div class="page_tips"><span></span></div>';
					var resumeHeight = $(".wbdCv-resume").css({"height" : "auto","min-height":1160}).outerHeight();
					$('.wbdCv-resume').css('height', resumeHeight + 'px');
					$(".wbdCv-resume").append(resumePageHtml);
					$("div.page_tips:last-child").css("top", resumeHeight + "px");
				} else {
					var nowPageSize = 0; // 当前页数
					var resumePageHeight = 1160;// 每页高度
					var resumePageHtml = '<div class="page_tips"><span></span></div>';
					var resumeHeight = $(".wbdCv-resume").css({"height" : "auto","min-height":1160}).outerHeight();
					var pageSize = Math.ceil(resumeHeight / resumePageHeight);
					$(".wbdCv-resume").css("height",resumePageHeight*pageSize);
					if(pageSize != nowPageSize){
						nowPageSize = pageSize;
						$("div.page_tips").remove();
						for(var index = 1; index <= pageSize; index++){
							var pageBreakObj = $(resumePageHtml);
							pageBreakObj.css({"top" : (index * resumePageHeight)-16 + "px"});
							pageBreakObj.find('span').text('第'+ index +'页');
							$(".wbdCv-resume").append(pageBreakObj);
						}
						$("div.page_tips:last-child").css("top", resumePageHeight*pageSize + "px");
					}
				}
			}
	    },
	    resume_visit_pwd:function(visitid,visitpwd){//密码访问简历
	    	$.ajax({type : "post",
	    		cache: false,
	    		async : false,
	    		url : "/cvresume/"+visitid+"/pwd/",
	    		data : {"visitpwd" : visitpwd},
	    		success : function(message) {
	    			if(message.type == "success"){
	    				location.href = "/cvresume/" + visitid + "/";
	    			}else{
	    				layer.msg(message.content);
	    			}
	    		}
	    	});
	    },
	    contact_me:function(resumeid){//联系我
            var name = $("#resume_contact").find('.resume_contact_name').text();
            var contact = $("#resume_contact").find('.resume_contact_mobile').text();
            var content = $("#resume_contact").find('.resume_contact_content').text();
            $.ajax({
                type: "POST",
                url: "/leaveWord/save/",
                data:{
                	resumeId:resumeid,
                	name:name,
                	contact:contact,
                	content:content
                },
                datetype:"Json",
                success: function(message){
                    if(message.type == "success"){
                    	layer.msg(message.content);
                    	$("#resume_contact").find('.resume_contact_name').text("");
                    	$("#resume_contact").find('.resume_contact_mobile').text("");
                    	$("#resume_contact").find('.resume_contact_content').text("");
                    } else {
                    	layer.msg(message.content);
                    }
                }
            });
	    },
	    is_empty:function(str){
	    	if(str==null||str==""||str==undefined){
	    		return true;
	    	}else{
	    		return false;
	    	}
	    },
	    is_empty_ext:function(str){
	    	if(str===null||str===""||str===undefined){
	    		return true;
	    	}else{
	    		return false;
	    	}
	    },
	    isJsonFormat:function(str){//json格式校验
	    	try{
	    		JSON.parse(str);
	    		return true;
	    	}catch(e){
				return false;
	    	}
	    },
	    isResumeMgFormat:function(resumeMg){//模块管理格式验证(resumeMg必须包含：isContenShow、isShow、isTimeShow、isTimeShow、key、title)
	    	if(cvresume.main.is_empty_ext(resumeMg)){
	    		return false;
	    	}
	    	if(cvresume.main.is_empty_ext(resumeMg.isContentShow)){//描述是否显示
	    		return false;
	    	}
	    	if(cvresume.main.is_empty_ext(resumeMg.isShow)){//模块是否显示
	    		return false;
	    	}
	    	if(cvresume.main.is_empty_ext(resumeMg.isTimeShow)){//时间模块是否显示
	    		return false;
	    	}
	    	if(cvresume.main.is_empty_ext(resumeMg.isTitleShow)){//标题是否显示
	    		return false;
	    	}
	    	if(cvresume.main.is_empty_ext(resumeMg.key)){//key
	    		return false;
	    	}
	    	if(resumeMg.title === undefined){//标题
	    		return false;
	    	}
	    	return true;
	    },
	    strToJson:function(str){ 
	    	return JSON.parse(str); 
	    },
	    set_visitid:function(visitid){
	    	$.post("/cvresume/set_visitid/",{"visitid":visitid,"resumeid":cvresume.info.resumeid},function(message){
	    		if(message.type=="success"){
	    			if(cvresume.main.is_empty(cvresume.info.resumeid)||cvresume.info.resumeid==0){
	    				var resumeJson=cvresume.main.strToJson(message.content);
		    			cvresume.info.resumeid=resumeJson.resumeid;
		    			cvresume.info.memberid=resumeJson.memberid;
		    		}
		    		var _oldVisitid = cvresume.info.visitid;
	    			cvresume.info.visitid=visitid;
	    			if(location.href.indexOf("/cvresume/"+_oldVisitid+"/") != -1){//发布页修改浏览器地址
		    			history.pushState(null,"个性域名修改",wbdcnf.base + "/cvresume/" + cvresume.info.visitid+"/");
		    		}
	    			layer.msg("修改成功~");
	    		}else{
	    			layer.msg(message.content);
	    			setTimeout(function(){
	    				$("#visitid").val(cvresume.info.visitid);
	    			},1500)
	    		}
	    	});
	    },
	    /**获取唯一标识*/
	    uuid:function() {
	        var uuid = "";
	        for (var i = 1; i <= 32; i++){
	          var n = Math.floor(Math.random() * 16.0).toString(16);
	          uuid += n;
	          if(i == 8 || i == 12 || i == 16 || i == 20)
	            uuid += "";
	        }
	        return uuid;    
	    },
	    replaceAll:function(str,sou,tar){
	    	return str.replace(new RegExp(sou,"gm"),tar); 	
	    },
	    //时间模块空值校验
	    timeModuleIsEmpty:function(str){
	    	if(cvresume.main.is_empty(str) || str == "开始时间" || str == "结束时间"){
	    		return true;
	    	}else{
	    		return false;
	    	}
	    },
	    gernateResumeWapQrCodeImage:function(resumeid){//生成手机简历二维码
	    	var message={};
	    	//1拼接二维码连接
	    	if(cvresume.main.is_empty(resumeid)){
	    		message["type"]="error";
	    		message["content"]="resumeid不能为空";
	    		return message;
	    	}
	    	//判断二维码图片地址
	    	var $resume_qrcode=$("#resume_qrcode").find("img")
	    	var resume_qrcode_url=$resume_qrcode.attr("src");
	    	if(resume_qrcode_url.indexOf("ad_Attention_weixin_ewm.png")==-1){
	    		message["type"]="error";
	    		message["content"]="已生成为二维码，不能重复生成";
	    		return message;
	    	}
	    	var host=location.hostname;
	    	var codeUrl=location.protocol+"//"+host+"/cvresume/qrcode_redirect/"+resumeid+"/";
	    	//2生成隐藏的画布节点
	    	var $qrCodeImage=$("#gernateResumeWapQrCodeImage");
	    	if($qrCodeImage.length<=0){
	    		$("body").append("<div style='display:none' id='gernateResumeWapQrCodeImage'></div>");
	    		$qrCodeImage=$("#gernateResumeWapQrCodeImage");
	    		$qrCodeImage.hide();
			}
			/**
			 * 二维码logo图片路径已在common.css中使用css的background-image发起请求，这里onload直接从缓存中读取
			 * 否则第一次加载图片由于异步进行，上传的二维码图片不会有logo
			 */
			var new_image = new Image(),
				logo_src = '/resources/500d/common/images/qrcode_icon_logo.png';
	    	$qrCodeImage.qrcode({ 
				render: "canvas",
	    	    width: 120,
	    	    height: 120,
				text: codeUrl,
				background: '#ffffff',
				foreground: '#000000',
				src: logo_src,
			}); 
			new_image.src = logo_src;
			// 二维码的logo加载完成
			new_image.onload = function(){
				//3获取图片base64编码
				var iamge_data=$qrCodeImage.children("canvas")[0].toDataURL("image/png");
				//4上传图片并返回连接
				$.post(wbdcnf.base+'/file/upload/cropper_image/',{"token" : getCookie("token"),"cropper_image":iamge_data.toString()},function(result){
					if(result.type == 'error'){
						message["type"]="error";
						message["content"]=result.content;
						return message;
					}else{
						 //调用更新接口
						 $.post(wbdcnf.base+'/cvresume/setResumeQrCodeImg/'+resumeid+'/',{"token" : getCookie("token"),"qrcodeImg":result.content},function(message){
							 if(message.type=="success"){
								 $resume_qrcode.attr("src",result.content);
								 message["type"]="success";
								message["content"]=result.content;
								return message;
							 }else{
								 message["type"]="error";
								message["content"]=message.content;
								return message;
							 }
						 });
					}
				});
			}
	    },
	    _500dtongji:function(lable){
	    	try{
	    		if (window.localStorage && (cvresume.main.is_empty(localStorage.getItem("pcEditDataUpdated")) || localStorage.getItem("pcEditDataUpdated") != cvresume.info.resumeid)) {
	    			common.main._500dtongji(lable);
	    			localStorage.setItem("pcEditDataUpdated",cvresume.info.resumeid);
				} 	
			}catch(e){
				console.log("统计埋点错误~");
			}
	    },
		preview_pdf:function(){
			var isChrome = navigator.userAgent.indexOf("Chrome");
			var isFirefox = navigator.userAgent.indexOf("Firefox");
			var is360 = window.navigator.mimeTypes[40] || !window.navigator.mimeTypes.length;
			var isqq = window.navigator.userAgent.indexOf('QQBrowser')>-1;
			var isSg = window.navigator.userAgent.toLowerCase().indexOf('se 2.x')>-1;
			var isSafari = window.navigator.userAgent.indexOf("Safari")>-1;
			var isIe = window.navigator.userAgent.indexOf('MSIE') >-1;
			function isShow(){
				$(".pdf_tips").addClass("show");				
			}
			function isHide(){
				$(".pdf_tips").removeClass("show");				
			}			
			if(is360 || isSg ){
				isShow();
			}else{
				isHide();
			}
			$(".pdf_tips .close").click(function(){
				isHide();
			});
		},
		moduleItemList_handlestyle: function(){
			// 手机模式不处理
			if ($('.wbdCv-baseStyle').parents('.mobile').length > 0) return;
			// 编辑页调用
			/**
			 * 基本信息
			 * 竖线分割样式处理最后一个竖线  css选择器没法去除最后一个  看到的最后一项并不是真正的最后一项
			 * 目前模板基本信息有2种样式 jm0203、jm0256 2套模板为例子  需要处理的只有jm0256这类的
			 */
			var $infoitem = $('.wbdCv-baseStyle .infoItem .info-list:visible');
			$infoitem.removeClass('last-child');
			$infoitem.last().addClass('last-child');
			/**
			 * 求职意向
			 * 自适应分布处理，导出pdf插件不支持flex
			 * 目前有少数模板是竖排显示的，需在模板css里覆盖这里的样式
			 * 
			 * 自适应规则：
			 * 清除外边距计算所有项所占总宽度，如果在一行内则平均分布外边距，最后一项不设置，公式：Math.floor( 容器宽 - 所有项总宽 ) / ( 项目数量 - 1 ) = 剩余空间
			 * 注：(项目数量需大于一)
			 * 多行情况时，每行剩余空间最大值不超过30像素，最后一项不设置
			 */
			var $inteitem = $('.wbdCv-baseStyle .inteItem .inte-list:visible');
			var $inteparent = $('.wbdCv-baseStyle .inteItem .inte-con');
			var intecontain_width = $inteparent.width();
			var inte_width = 0;
			var inte_line = 1;
			$inteitem.each(function(i, item){
				$(item).removeAttr('style');
				// 内容总长
				inte_width += $(item).outerWidth();
				// 设置行
				var item_line = (item.offsetTop + $(item).outerHeight()) / $inteparent.height() * ($inteparent.height() / $(item).outerHeight());
				$(item).attr('temp-line', item_line);
				inte_line = item_line;
				// 设置列 索引值1开始
				$(item).attr('temp-index', 1);
				if (i > 0) {
					var $prev = $inteitem.eq(i - 1);
					if ($prev.attr('temp-line') === $(item).attr('temp-line')) {
						$(item).attr('temp-index', +$prev.attr('temp-index') + 1);
					} else {
						$(item).attr('temp-index', 1);
					}
				}
			});
			if (intecontain_width >= inte_width && $inteitem.length > 2) {
				var inte_margin = Math.floor((intecontain_width - inte_width) / ($inteitem.length - 1)) - 2; // 每个项减少一个像素预留出空位防止计算错误
				if (inte_margin < 0) inte_margin = 0;
				$inteitem.not($inteitem.eq($inteitem.length - 1)).css('margin-right', inte_margin + 'px');
			} else {
				for (var i = 1; i <= inte_line; i++) {
					var $inteitem_line = $('.wbdCv-baseStyle .inteItem .inte-list[temp-line='+ i +']');
					var inte_line_width = 0;
					$inteitem_line.each(function(){
						inte_line_width += $(this).outerWidth();
					});
					$inteitem_line.each(function(){
						var inte_margin = Math.floor((intecontain_width - inte_line_width) / (($inteitem_line.length - 1) || 1) ) - 2; // 每个项减少2个像素预留出空位防止计算错误
						if (inte_margin < 0) inte_margin = 0;
						if (inte_margin > 30) inte_margin = 30;
						$inteitem_line.not($inteitem_line.eq($inteitem_line.length - 1)).css('margin-right', inte_margin + 'px');
					});
				}
			}
		},
}
$(function(){
	cvresume.main.init_();//初始化
});